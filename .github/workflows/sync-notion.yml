name: Sync Notion Places

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Quick sanity check (lockfile & Node)
        run: |
          echo "Node $(node -v)"
          test -f package-lock.json && echo "✅ package-lock.json found" || (echo "::error::❌ package-lock.json missing"; exit 1)
          test -f scripts/sync-place.js && echo "✅ sync script found" || (echo "::error::❌ scripts/sync-place.js missing"; exit 1)

      - name: Check required secrets are set
        env:
          NOTION_KEY: ${{ secrets.NOTION_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          KAKAO_REST_API: ${{ secrets.KAKAO_REST_API }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          for V in NOTION_KEY NOTION_DATABASE_ID KAKAO_REST_API; do
            if [ -z "${!V}" ]; then
              echo "::error::Missing secret: $V"
              exit 1
            else
              echo "✅ $V is set"
            fi
          done
          # OpenAI는 선택
          if [ -z "${OPENAI_API_KEY}" ]; then
            echo "ℹ️ OPENAI_API_KEY not set (summary는 기본문구 fallback)"
          else
            echo "✅ OPENAI_API_KEY is set"
          fi

      - name: Install deps (lockfile-based)
        run: npm ci

      - name: Run sync script
        env:
          NOTION_KEY: ${{ secrets.NOTION_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          KAKAO_REST_API: ${{ secrets.KAKAO_REST_API }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: node scripts/sync-place.js
