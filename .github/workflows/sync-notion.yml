name: Sync Notion Places

on:
  workflow_dispatch:
    inputs:
      force_summary:
        description: 'Í∞ïÏ†úÎ°ú ÏöîÏïΩ Ïû¨ÏÉùÏÑ± (true/false)'
        required: false
        default: 'true'
      force_google:
        description: 'Íµ¨Í∏Ä ÌïÑÎìú Í∞ïÏ†ú Í∞±Ïã† (true/false)'
        required: false
        default: 'true'
      skip_kakao:
        description: 'Ïπ¥Ïπ¥Ïò§ Í≤ÄÏÉâ Ïä§ÌÇµ (true/false)'
        required: false
        default: 'false'
      verbose:
        description: 'ÏÉÅÏÑ∏ Î°úÍ∑∏ (true/false)'
        required: false
        default: 'true'

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Quick sanity check (lockfile & script)
        run: |
          echo "Node $(node -v)"
          test -f package-lock.json && echo "‚úÖ package-lock.json found" || (echo "::error::‚ùå package-lock.json missing"; exit 1)
          test -f scripts/sync-place.js && echo "‚úÖ scripts/sync-place.js found" || (echo "::error::‚ùå scripts/sync-place.js missing"; exit 1)

      - name: Check required secrets/vars presence
        env:
          NOTION_TOKEN:       ${{ secrets.NOTION_TOKEN || secrets.NOTION_KEY || secrets.NOTION }}
          NOTION_DATABASE_ID: ${{ vars.NOTION_DATABASE_ID || secrets.NOTION_DATABASE_ID }}
          KAKAO_REST_API:     ${{ secrets.KAKAO_REST_API || secrets.KAKAO_REST_API_KEY }}
          OPENAI_API_KEY:     ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY:     ${{ secrets.GOOGLE_API_KEY }}
        run: |
          required_envs=(NOTION_TOKEN NOTION_DATABASE_ID KAKAO_REST_API OPENAI_API_KEY GOOGLE_API_KEY)
          for V in "${required_envs[@]}"; do
            if [ -z "${!V}" ]; then
              echo "::error::Missing required secret/var: $V"
              exit 1
            else
              echo "‚úÖ $V is set"
            fi
          done

      - name: Install deps (lockfile-based)
        run: npm ci

      - name: Show env presence (no secrets)
        env:
          NOTION_TOKEN:       ${{ secrets.NOTION_TOKEN || secrets.NOTION_KEY || secrets.NOTION }}
          NOTION_DATABASE_ID: ${{ vars.NOTION_DATABASE_ID || secrets.NOTION_DATABASE_ID }}
          KAKAO_REST_API:     ${{ secrets.KAKAO_REST_API || secrets.KAKAO_REST_API_KEY }}
          OPENAI_API_KEY:     ${{ secrets.OPENAI_API_KEY }}
          OPENAI_PROJECT:     ${{ secrets.OPENAI_PROJECT }}
          GOOGLE_API_KEY:     ${{ secrets.GOOGLE_API_KEY }}
          FORCE_SUMMARY:      ${{ github.event.inputs.force_summary || 'false' }}
          FORCE_GOOGLE:       ${{ github.event.inputs.force_google  || 'false' }}
          SKIP_KAKAO:         ${{ github.event.inputs.skip_kakao    || 'false' }}
          VERBOSE:            ${{ github.event.inputs.verbose       || 'true'  }}
        run: |
          node -e "console.log({
            HAS_NOTION:!!process.env.NOTION_TOKEN,
            HAS_DB:!!process.env.NOTION_DATABASE_ID,
            HAS_KAKAO:!!process.env.KAKAO_REST_API,
            HAS_OPENAI:!!process.env.OPENAI_API_KEY,
            HAS_GOOGLE:!!process.env.GOOGLE_API_KEY,
            FORCE_SUMMARY:process.env.FORCE_SUMMARY,
            FORCE_GOOGLE:process.env.FORCE_GOOGLE,
            SKIP_KAKAO:process.env.SKIP_KAKAO,
            VERBOSE:process.env.VERBOSE
          })"

      # üîπ OpenAI ÌÇ§ ÏÇ¨Ï†Ñ Ìïë Ï≤¥ÌÅ¨ (env ÏïàÏóê run ÎÑ£ÏßÄ ÎßêÍ≥† Î≥ÑÎèÑ step)
      - name: Sanity ping OpenAI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          node -e "const k=(process.env.OPENAI_API_KEY||'').trim(); console.log('LEN',k.length,'HEAD',k.slice(0,6)); if(!k){process.exit(1)}"
          node -e "
            const https=require('https');
            const k=(process.env.OPENAI_API_KEY||'').trim();
            const req=https.request(
              {hostname:'api.openai.com',path:'/v1/models',method:'GET',headers:{Authorization:'Bearer '+k}},
              r=>{console.log('OpenAI /v1/models status=',r.statusCode); r.resume(); if(r.statusCode!==200){process.exit(2)}}
            ); req.on('error',e=>{console.error(e);process.exit(3)}); req.end();
          "

      - name: Run sync script
        env:
          # Ïä§ÌÅ¨Î¶ΩÌä∏ÏóêÏÑú ÏùΩÎäî Ïù¥Î¶ÑÍ≥º Ï†ïÌôïÌûà Îß§Ïπ≠
          NOTION_TOKEN:       ${{ secrets.NOTION_TOKEN || secrets.NOTION_KEY || secrets.NOTION }}
          NOTION_DATABASE_ID: ${{ vars.NOTION_DATABASE_ID || secrets.NOTION_DATABASE_ID }}
          KAKAO_REST_API:     ${{ secrets.KAKAO_REST_API || secrets.KAKAO_REST_API_KEY }}
          OPENAI_API_KEY:     ${{ secrets.OPENAI_API_KEY }}
          OPENAI_PROJECT:     ${{ secrets.OPENAI_PROJECT || '' }}
          GOOGLE_API_KEY:     ${{ secrets.GOOGLE_API_KEY }}
          FORCE_SUMMARY:      ${{ github.event.inputs.force_summary || 'false' }}
          FORCE_GOOGLE:       ${{ github.event.inputs.force_google  || 'false' }}
          SKIP_KAKAO:         ${{ github.event.inputs.skip_kakao    || 'false' }}
          VERBOSE:            ${{ github.event.inputs.verbose       || 'true'  }}
        run: node scripts/sync-place.js

      - name: Debug Google key
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          node -e "const k=(process.env.GOOGLE_API_KEY||'').trim(); console.log('ACTION LEN',k.length,'HEAD',k.slice(0,6));"

